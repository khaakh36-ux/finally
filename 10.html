<!DOCTYPE html>
<html lang="so">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nidaamka Attendance ee Casriga ah</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --accent: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --text: #34495e;
            --admin: #9b59b6;
            --super-admin: #34495e;
            --school-admin: #8e44ad;
            --teacher: #1abc9c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary), #0984e3);
        }

        .login-form {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-form h2 {
            color: var(--primary);
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .login-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-btn:hover {
            background: #2980b9;
        }

        .error-message {
            color: red;
            margin-top: 10px;
            display: none;
        }

        /* Header */
        header {
            background: var(--dark);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2rem;
            color: var(--secondary);
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .logout-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Navigation */
        nav {
            background: white;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav-tabs {
            display: flex;
            list-style: none;
        }

        .nav-tabs li {
            padding: 1rem;
        }

        .nav-tabs li a {
            text-decoration: none;
            color: var(--dark);
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .nav-tabs li a:hover, .nav-tabs li a.active {
            background: var(--primary);
            color: white;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 20px;
            padding: 20px;
            color: var(--text);
        }
        
        /* Two-column layout for some admin forms */
        .two-column-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        /* Sidebar */
        .sidebar {
            background: var(--light);
            border-radius: 10px;
            padding: 20px;
        }

        .sidebar h2 {
            color: var(--dark);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .class-list {
            list-style: none;
            margin-bottom: 20px;
        }

        .class-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid var(--primary);
        }
        
        .class-list li .class-name {
            flex-grow: 1;
        }

        .class-list li:hover {
            background: #dfe6e9;
            transform: translateX(5px);
        }

        .class-list li.active {
            background: var(--primary);
            color: white;
        }

        .class-list li.active .delete-btn {
            background-color: white;
            color: var(--accent);
        }
        
        .class-list li.active:hover .delete-btn {
            background-color: var(--accent);
            color: white;
        }
        
        /* Add class/school forms */
        .add-item-form {
            margin-top: 20px;
            display: grid;
            gap: 10px;
        }

        .add-item-form input, .add-item-form select, .add-item-form button {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        /* Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .stat-present i {
            color: var(--secondary);
        }

        .stat-absent i {
            color: var(--accent);
        }

        .stat-late i {
            color: var(--warning);
        }

        .stat-total i {
            color: var(--primary);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        /* Attendance Section */
        .attendance-section {
            background: var(--light);
            border-radius: 10px;
            padding: 20px;
        }

        .attendance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #bdc3c7;
        }

        .date-display {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }

        .session-selector select {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: white;
            font-size: 1rem;
        }

        .student-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .student-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .student-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .student-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .student-info img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            border: 3px solid var(--light);
        }

        .student-details h3 {
            color: var(--dark);
            margin-bottom: 5px;
        }

        .student-details p {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .attendance-actions {
            display: flex;
            justify-content: space-between;
        }

        .attendance-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-present {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .btn-present:hover, .btn-present.active {
            background: #2e7d32;
            color: white;
        }

        .btn-absent {
            background: #ffebee;
            color: #c62828;
        }

        .btn-absent:hover, .btn-absent.active {
            background: #c62828;
            color: white;
        }

        .btn-late {
            background: #fff8e1;
            color: #f57c00;
        }

        .btn-late:hover, .btn-late.active {
            background: #f57c00;
            color: white;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-save {
            background: var(--secondary);
            color: white;
        }

        .btn-save:hover {
            background: #27ae60;
        }

        .btn-export {
            background: var(--primary);
            color: white;
        }

        .btn-export:hover {
            background: #2980b9;
        }
        
        /* Reports Section */
        .reports-section {
            background: var(--light);
            border-radius: 10px;
            padding: 20px;
        }

        .report-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .report-filters select, .report-filters input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .report-result {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        /* Alerts Section */
        .alerts-section {
            background: var(--light);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .alert-list {
            list-style: none;
        }

        .alert-list li {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid var(--warning);
            background: #fff8e1;
            color: var(--text);
        }

        /* Student Management */
        .student-management {
            background: var(--light);
            border-radius: 10px;
            padding: 20px;
        }

        .add-student-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .add-student-form input, .add-student-form select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        /* Footer */
        footer {
            background: var(--dark);
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 30px;
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }

            .student-list {
                grid-template-columns: 1fr;
            }

            .add-student-form {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: wrap;
            }

            .attendance-header {
                flex-direction: column;
                gap: 15px;
            }

            .attendance-actions {
                flex-direction: column;
                gap: 10px;
            }

            .attendance-btn {
                width: 100%;
            }

            .report-filters {
                flex-direction: column;
            }
        }

        .hidden {
            display: none;
        }

        .admin-color {
            color: var(--super-admin);
        }
        
        .school-admin-color {
            color: var(--school-admin);
        }

        .teacher-color {
            color: var(--teacher);
        }

        .table-container {
            overflow-x: auto;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-table th, .report-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .report-table th {
            background-color: var(--primary);
            color: white;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            font-size: 1rem;
            transition: color 0.3s;
            margin-left: 10px;
        }

        .delete-btn:hover {
            color: #c0392b;
        }
    </style>
</head>
<body onload="initApp()">
    <div id="login-screen" class="login-container">
        <div class="login-form">
            <h2><i class="fas fa-school"></i> Nidaamka Attendance</h2>
             <div class="form-group" id="school-select-group">
                <label for="school-select">Dooro Dugsiga</label>
                <select id="school-select"></select>
            </div>
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Geli username-kaaga">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Geli password-kaaga">
            </div>
            <div class="form-group">
                <label for="role">Dooro Role-ka</label>
                <select id="role">
                    <option value="super-admin">Super Admin</option>
                    <option value="school-admin">Admin-ka Dugsiga</option>
                    <option value="teacher">Macallin</option>
                </select>
            </div>
            <button class="login-btn" onclick="login()">Login</button>
            <p class="error-message" id="error-message"></p>
            <p style="margin-top: 15px; color: #7f8c8d;">
                Super Admin: **superadmin** / Password: **super123**<br>
                Adminka Dugsiga: **admin** / Password: **admin123**<br>
                Macallin: **teacher** / Password: **teacher123**
            </p>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <header>
            <div class="logo">
                <i class="fas fa-school"></i>
                <h1 id="school-name-display"></h1>
            </div>
            <div class="user-info">
                <img id="user-avatar" src="https://ui-avatars.com/api/?name=User&background=3498db&color=fff" alt="User">
                <div>
                    <div id="user-name">User</div>
                    <small id="user-role">Role</small>
                </div>
                <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Ka Bax</button>
            </div>
        </header>

        <nav>
            <ul class="nav-tabs" id="main-nav">
            </ul>
        </nav>

        <div class="container">
            <div id="dashboard-tab" class="main-content hidden">
                <div class="sidebar">
                    <h2>Fasallada</h2>
                    <ul class="class-list" id="dashboard-classes-list">
                    </ul>
                </div>

                <div class="attendance-section">
                    <h2>Welcome <span id="dashboard-username"></span>!</h2>
                    <p>Dashboard-kaagu wuxuu ku tusayaa xogta ugu dambeysay ee attendance-ka.</p>

                    <div class="dashboard" id="dashboard-stats">
                        <div class="stat-card stat-present">
                            <i class="fas fa-check-circle"></i>
                            <h3 id="present-count">0</h3>
                            <p>Hadsan</p>
                        </div>
                        <div class="stat-card stat-absent">
                            <i class="fas fa-times-circle"></i>
                            <h3 id="absent-count">0</h3>
                            <p>Maqan</p>
                        </div>
                        <div class="stat-card stat-late">
                            <i class="fas fa-clock"></i>
                            <h3 id="late-count">0</h3>
                            <p>Daahaday</p>
                        </div>
                        <div class="stat-card stat-total">
                            <i class="fas fa-users"></i>
                            <h3 id="total-count">0</h3>
                            <p>Wadarta</p>
                        </div>
                    </div>

                    <div class="alerts-section">
                        <h2>Ogeysiisyada</h2>
                        <ul class="alert-list" id="alert-list">
                        </ul>
                    </div>
                </div>
            </div>

            <div id="attendance-tab" class="main-content hidden">
                 <div class="sidebar">
                    <h2>Fasallada</h2>
                    <ul class="class-list" id="attendance-classes-list">
                    </ul>
                </div>
                <div class="attendance-section">
                    <h2>Diiwaanka Attendance-ka</h2>
                    <div class="attendance-header">
                        <div class="date-display" id="current-date"></div>
                        <div class="session-selector">
                            <select id="session-select">
                                <option value="morning">Subax</option>
                                <option value="afternoon">Galab</option>
                            </select>
                        </div>
                    </div>

                    <div class="student-list" id="student-list-container">
                        <p>Fadlan dooro fasal si aad u diiwaangeliso attendance-ka.</p>
                    </div>

                    <div class="action-buttons">
                        <button class="action-btn btn-save" onclick="saveAttendance()">Keydi</button>
                        <button class="action-btn btn-export" onclick="exportAttendance()">PDF</button>
                    </div>
                </div>
            </div>

            <div id="students-tab" class="main-content hidden">
                 <div class="sidebar">
                    <h2>Fasallada</h2>
                    <ul class="class-list" id="students-classes-list">
                    </ul>
                </div>
                <div class="student-management">
                    <h2>Maareynta Ardayda</h2>
                    <div class="add-item-form">
                        <input type="text" id="student-name" placeholder="Magaca Ardayga">
                        <input type="tel" id="student-id" placeholder="Lambarka Waalidka">
                        <select id="student-class">
                            <option value="">Dooro Fasalka</option>
                        </select>
                        <button class="action-btn btn-save" onclick="addStudent()">Ku Dar Ardayga</button>
                    </div>

                    <div class="reports-section" style="margin-top: 20px;">
                        <h3>Liiska Ardayda</h3>
                        <div class="report-result" id="student-list-report">
                            <p>Fadlan dooro fasal si aad u aragto liiska ardayda.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="reports-tab" class="main-content hidden">
                <div class="sidebar">
                    <h2>Fasallada</h2>
                    <ul class="class-list" id="reports-classes-list">
                    </ul>
                </div>
                <div class="reports-section">
                    <h2>Warbixinnada Faahfaahsan</h2>
                    <div class="report-filters">
                        <select id="detailed-report-class">
                            <option value="">Dooro Fasalka</option>
                        </select>
                        <input type="date" id="report-start-date">
                        <input type="date" id="report-end-date">
                        <button class="action-btn btn-export" onclick="generateDetailedReport()">Soo Saro Warbixin</button>
                    </div>
                    <div class="report-result" id="detailed-report-result">
                        <p>Fadlan dooro fasal iyo taariikho si aad u soo saarto warbixin.</p>
                    </div>
                </div>
            </div>

            <div id="school-admin-tab" class="main-content hidden">
                <div class="sidebar">
                    <h2>Fasallada</h2>
                    <ul class="class-list" id="school-admin-classes-list">
                    </ul>
                    <div class="add-item-form">
                        <input type="text" id="new-class-name" placeholder="Magaca Fasalka Cusub">
                        <button class="action-btn btn-save" onclick="addNewClass()">Ku Dar Fasalka</button>
                    </div>
                </div>
                <div class="student-management">
                    <h2>Maamulka Dugsiga</h2>
                    <div style="margin-bottom: 20px;">
                        <h3>Ku Dar Macallin Cusub</h3>
                        <div class="two-column-form">
                            <input type="text" id="new-teacher-username" placeholder="Username">
                            <input type="password" id="new-teacher-password" placeholder="Password">
                        </div>
                        <button class="action-btn btn-save" onclick="addTeacher()">Ku Dar Macallinka</button>
                    </div>
                    <div class="reports-section">
                        <h3>Accounts-ka Macallimiinta</h3>
                        <div class="report-result" id="teacher-list">
                        </div>
                    </div>
                </div>
            </div>

            <div id="super-admin-tab" class="main-content hidden">
                <div class="sidebar">
                    <h2>Maamulka Dugsiyada</h2>
                    <ul class="class-list" id="super-admin-schools-list">
                    </ul>
                    <div class="add-item-form">
                        <input type="text" id="new-school-name" placeholder="Magaca Dugsiga Cusub">
                        <button class="action-btn btn-save" onclick="addNewSchool()">Ku Dar Dugsiga</button>
                    </div>
                </div>
                <div class="student-management">
                    <h2>Maamulka Super Admin</h2>
                    <div style="margin-bottom: 20px;">
                        <h3>Ku Samee Admin Cusub Dugsiga</h3>
                        <div class="two-column-form">
                            <input type="text" id="new-school-admin-username" placeholder="Username">
                            <input type="password" id="new-school-admin-password" placeholder="Password">
                        </div>
                        <select id="new-school-admin-school"></select>
                        <button class="action-btn btn-save" onclick="addSchoolAdmin()">Ku Samee Admin</button>
                    </div>
                    <div class="reports-section">
                        <h3>Accounts-ka Dugsiyada</h3>
                        <div class="report-result" id="school-admin-list">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>Nidaamka Attendance ee Casriga ah &copy; 2024. Dhamaan Xuquuqda Way Dhawrsan Yihiin.</p>
        </footer>
    </div>

    <script>
        window.jsPDF = window.jspdf.jsPDF;

        let schools = {};
        let currentSchoolKey = null;
        let attendanceData = {};
        let currentUser = null;
        let users = {};

        function initApp() {
            loadData();
            updateLoginView();
            
            const savedUser = sessionStorage.getItem('currentUser');
            const savedSchoolKey = sessionStorage.getItem('currentSchoolKey');
            if (savedUser && savedSchoolKey) {
                currentUser = JSON.parse(savedUser);
                currentSchoolKey = savedSchoolKey;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                showApp();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        }

        function loadData() {
            const savedSchools = localStorage.getItem('attendanceSchools');
            const savedAttendance = localStorage.getItem('attendanceData');
            const savedUsers = localStorage.getItem('attendanceUsers');

            if (savedSchools) {
                schools = JSON.parse(savedSchools);
            }
            if (savedAttendance) {
                attendanceData = JSON.parse(savedAttendance);
            }
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }
            
            // Default Super Admin User
            if (!users['superadmin']) {
                users['superadmin'] = { username: 'superadmin', password: 'super123', role: 'super-admin' };
                localStorage.setItem('attendanceUsers', JSON.stringify(users));
            }
            
            // Default School Admin and School
            const defaultSchoolKey = 'dugsiga_hore';
            if (!schools[defaultSchoolKey]) {
                schools[defaultSchoolKey] = {
                    name: 'Dugsiga Hore',
                    classes: ['Fasalka 1', 'Fasalka 2'],
                    students: {
                        'Fasalka 1': [
                            { id: '6175551234', name: 'Axmed Cali', image: 'https://ui-avatars.com/api/?name=Axmed+Cali&background=3498db&color=fff' },
                            { id: '6185551234', name: 'Maxamed Xasan', image: 'https://ui-avatars.com/api/?name=Maxamed+Xasan&background=2ecc71&color=fff' }
                        ],
                        'Fasalka 2': [
                            { id: '6195551234', name: 'Sacdiyo Yuusuf', image: 'https://ui-avatars.com/api/?name=Sacdiyo+Yuusuf&background=e74c3c&color=fff' },
                            { id: '6205551234', name: 'Fadumo Maxamed', image: 'https://ui-avatars.com/api/?name=Fadumo+Maxamed&background=f39c12&color=fff' }
                        ]
                    }
                };
                saveData();
            }
            
            if (!users['admin']) {
                users['admin'] = { username: 'admin', password: 'admin123', role: 'school-admin', schoolKey: defaultSchoolKey };
                localStorage.setItem('attendanceUsers', JSON.stringify(users));
            }

            if (!users['teacher']) {
                users['teacher'] = { username: 'teacher', password: 'teacher123', role: 'teacher', schoolKey: defaultSchoolKey };
                localStorage.setItem('attendanceUsers', JSON.stringify(users));
            }
        }

        function saveData() {
            localStorage.setItem('attendanceSchools', JSON.stringify(schools));
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            localStorage.setItem('attendanceUsers', JSON.stringify(users));
        }

        function updateLoginView() {
            const roleSelect = document.getElementById('role');
            const schoolSelectGroup = document.getElementById('school-select-group');
            const schoolSelect = document.getElementById('school-select');
            
            roleSelect.onchange = () => {
                const selectedRole = roleSelect.value;
                if (selectedRole === 'super-admin') {
                    schoolSelectGroup.style.display = 'none';
                } else {
                    schoolSelectGroup.style.display = 'block';
                }
            };
            
            schoolSelect.innerHTML = '';
            for (const key in schools) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = schools[key].name;
                schoolSelect.appendChild(option);
            }
        }

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;
            const schoolKey = document.getElementById('school-select').value;
            const errorMessage = document.getElementById('error-message');
            
            errorMessage.style.display = 'none';
            const user = users[username];

            if (!user || user.password !== password || user.role !== role) {
                errorMessage.textContent = 'Username-ka, password-ka ama doorashada doorka khalad ah.';
                errorMessage.style.display = 'block';
                return;
            }

            if (user.role !== 'super-admin' && user.schoolKey !== schoolKey) {
                 errorMessage.textContent = 'Username-kan wuxuu gaar u yahay dugsi kale.';
                 errorMessage.style.display = 'block';
                return;
            }

            currentUser = user;
            currentSchoolKey = user.role === 'super-admin' ? null : schoolKey;
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            sessionStorage.setItem('currentSchoolKey', currentSchoolKey);
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            showApp();
        }

        function logout() {
            sessionStorage.removeItem('currentUser');
            sessionStorage.removeItem('currentSchoolKey');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
            document.getElementById('error-message').style.display = 'none';
        }

        function showApp() {
            document.getElementById('user-name').textContent = currentUser.username;
            document.getElementById('user-role').textContent = currentUser.role === 'super-admin' ? 'Super Admin' : (currentUser.role === 'school-admin' ? 'Admin-ka Dugsiga' : 'Macallin');
            document.getElementById('dashboard-username').textContent = currentUser.username;
            
            let avatarBgColor = '';
            if (currentUser.role === 'super-admin') avatarBgColor = '34495e';
            else if (currentUser.role === 'school-admin') avatarBgColor = '8e44ad';
            else avatarBgColor = '1abc9c';

            const avatarUrl = `https://ui-avatars.com/api/?name=${currentUser.username.replace(' ', '+')}&background=${avatarBgColor}&color=fff`;
            document.getElementById('user-avatar').src = avatarUrl;
            
            if (currentSchoolKey) {
                document.getElementById('school-name-display').textContent = schools[currentSchoolKey].name;
            } else {
                document.getElementById('school-name-display').textContent = 'Super Admin Dashboard';
            }

            setupNavigation();

            if (currentUser.role === 'super-admin') {
                showTab('super-admin');
            } else if (currentUser.role === 'school-admin') {
                showTab('school-admin');
            } else {
                showTab('attendance');
            }
        }

        function setupNavigation() {
            const navContainer = document.getElementById('main-nav');
            navContainer.innerHTML = '';

            const navItems = {
                'super-admin': [
                    { name: 'Maamulka Super Admin', icon: 'fas fa-shield-alt', tab: 'super-admin' }
                ],
                'school-admin': [
                    { name: 'Dashboard', icon: 'fas fa-tachometer-alt', tab: 'dashboard' },
                    { name: 'Maamulka Dugsiga', icon: 'fas fa-cog', tab: 'school-admin' },
                    { name: 'Ardayda', icon: 'fas fa-user-graduate', tab: 'students' },
                    { name: 'Warbixinnada', icon: 'fas fa-chart-bar', tab: 'reports' }
                ],
                'teacher': [
                    { name: 'Attendance', icon: 'fas fa-clipboard-check', tab: 'attendance' },
                    { name: 'Ardayda', icon: 'fas fa-user-graduate', tab: 'students' },
                    { name: 'Warbixinnada', icon: 'fas fa-chart-bar', tab: 'reports' }
                ]
            };
            
            const roleNav = navItems[currentUser.role];
            roleNav.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<a href="#" onclick="showTab('${item.tab}')"><i class="${item.icon}"></i> ${item.name}</a>`;
                navContainer.appendChild(li);
            });
        }

        function showTab(tabName) {
            document.querySelectorAll('.main-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');

            document.querySelectorAll('.nav-tabs a').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.nav-tabs a[onclick*="${tabName}"]`).classList.add('active');

            if (tabName === 'attendance') {
                updateClassesList('attendance', false);
                displayAttendanceTab();
            } else if (tabName === 'students') {
                updateClassesList('students', currentUser.role === 'school-admin');
                updateStudentClassSelect();
                loadStudentList();
            } else if (tabName === 'reports') {
                updateClassesList('reports', false);
                updateReportFilters();
                document.getElementById('detailed-report-result').innerHTML = '<p>Fadlan dooro fasal iyo taariikho si aad u soo saarto warbixin.</p>';
            } else if (tabName === 'school-admin') {
                updateClassesList('school-admin', true);
                loadTeacherList();
            } else if (tabName === 'super-admin') {
                updateSuperAdminView();
            } else if (tabName === 'dashboard') {
                updateClassesList('dashboard', false);
                updateStats();
                loadAlerts();
            }
        }
        
        // --- Super Admin Functions ---
        
        function updateSuperAdminView() {
            updateSuperAdminSchoolsList();
            updateSchoolAdminSchoolSelect();
            loadSchoolAdminList();
        }

        function updateSuperAdminSchoolsList() {
            const schoolsList = document.getElementById('super-admin-schools-list');
            schoolsList.innerHTML = '';
            for (const key in schools) {
                const li = document.createElement('li');
                li.innerHTML = `<span class="class-name">${schools[key].name}</span>`;
                schoolsList.appendChild(li);
            }
        }
        
        function addNewSchool() {
            const schoolName = document.getElementById('new-school-name').value.trim();
            if (schoolName) {
                const schoolKey = schoolName.toLowerCase().replace(/\s/g, '_');
                if (!schools[schoolKey]) {
                    schools[schoolKey] = {
                        name: schoolName,
                        classes: [],
                        students: {}
                    };
                    saveData();
                    updateLoginView();
                    updateSuperAdminSchoolsList();
                    updateSchoolAdminSchoolSelect();
                    document.getElementById('new-school-name').value = '';
                    alert('Dugsiga cusub si guul leh ayaa loo daray!');
                } else {
                    alert('Dugsigan horey wuu u jiraa.');
                }
            }
        }
        
        function addSchoolAdmin() {
            const username = document.getElementById('new-school-admin-username').value.trim();
            const password = document.getElementById('new-school-admin-password').value.trim();
            const school = document.getElementById('new-school-admin-school').value;

            if (!username || !password || !school) {
                alert('Fadlan buuxi dhammaan macluumaadka.');
                return;
            }

            if (users[username]) {
                alert('Username-kan horey wuu u jiraa. Fadlan dooro mid kale.');
                return;
            }

            users[username] = { username, password, role: 'school-admin', schoolKey: school };
            saveData();
            alert(`Admin cusub (${username}) si guul leh ayaa loo sameeyey Dugsiga: ${schools[school].name}!`);
            document.getElementById('new-school-admin-username').value = '';
            document.getElementById('new-school-admin-password').value = '';
            loadSchoolAdminList();
        }

        function updateSchoolAdminSchoolSelect() {
            const select = document.getElementById('new-school-admin-school');
            select.innerHTML = '';
            for (const key in schools) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = schools[key].name;
                select.appendChild(option);
            }
        }
        
        function loadSchoolAdminList() {
            const adminList = document.getElementById('school-admin-list');
            adminList.innerHTML = '';
            const schoolAdmins = Object.values(users).filter(u => u.role === 'school-admin');
            if (schoolAdmins.length === 0) {
                adminList.innerHTML = '<p>Ma jiraan Admin-ka Dugsiyada la diiwaangeliyey.</p>';
                return;
            }
            
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';
            const table = document.createElement('table');
            table.className = 'report-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Dugsiga</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            `;
            const tbody = table.querySelector('tbody');
            schoolAdmins.forEach(admin => {
                const row = document.createElement('tr');
                const schoolName = schools[admin.schoolKey] ? schools[admin.schoolKey].name : 'N/A';
                row.innerHTML = `
                    <td>${admin.username}</td>
                    <td>${schoolName}</td>
                `;
                tbody.appendChild(row);
            });
            tableContainer.appendChild(table);
            adminList.appendChild(tableContainer);
        }
        
        // --- School Admin Functions ---

        function addNewClass() {
            const className = document.getElementById('new-class-name').value.trim();
            if (className) {
                if (!schools[currentSchoolKey].classes.includes(className)) {
                    schools[currentSchoolKey].classes.push(className);
                    schools[currentSchoolKey].students[className] = [];
                    saveData();
                    updateClassesList('school-admin', true);
                    alert('Fasalka si guul leh ayaa loo daray!');
                    document.getElementById('new-class-name').value = '';
                } else {
                    alert('Fasalkan horey wuu u jiraa.');
                }
            }
        }

        function deleteClass(className) {
            if (confirm(`Ma hubtaa inaad tirtirto fasalka "${className}"? Tani waxay tirtiraysaa dhammaan ardayda iyo xogtooda attendance-ka ee fasalkan.`)) {
                const currentSchool = schools[currentSchoolKey];
                currentSchool.classes = currentSchool.classes.filter(cls => cls !== className);
                delete currentSchool.students[className];
                
                // Also delete attendance data for this class
                for (const key in attendanceData) {
                    if (key.startsWith(`${currentSchoolKey}-`) && key.includes(`-${className}-`)) {
                        delete attendanceData[key];
                    }
                }
                
                saveData();
                updateClassesList('school-admin', true);
                loadStudentList();
                alert('Fasalka si guul leh ayaa loo tirtiray!');
            }
        }

        function addTeacher() {
            const username = document.getElementById('new-teacher-username').value.trim();
            const password = document.getElementById('new-teacher-password').value.trim();

            if (!username || !password) {
                alert('Fadlan geli username iyo password.');
                return;
            }

            if (users[username]) {
                alert('Username-kan horey wuu u jiraa. Fadlan dooro mid kale.');
                return;
            }

            users[username] = { username, password, role: 'teacher', schoolKey: currentSchoolKey };
            saveData();
            alert(`Macallin cusub (${username}) si guul leh ayaa loo daray!`);
            document.getElementById('new-teacher-username').value = '';
            document.getElementById('new-teacher-password').value = '';
            loadTeacherList();
        }

        function deleteTeacher(username) {
            if (confirm(`Ma hubtaa inaad tirtirto macallinka "${username}"?`)) {
                delete users[username];
                saveData();
                loadTeacherList();
                alert('Macallinka si guul leh ayaa loo tirtiray!');
            }
        }

        function loadTeacherList() {
            const teacherList = document.getElementById('teacher-list');
            teacherList.innerHTML = '';
            const teachers = Object.values(users).filter(u => u.role === 'teacher' && u.schoolKey === currentSchoolKey);
            if (teachers.length === 0) {
                teacherList.innerHTML = '<p>Ma jiraan macallimiin la diiwaangeliyey.</p>';
                return;
            }

            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';
            const table = document.createElement('table');
            table.className = 'report-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Tirtir</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            `;
            const tbody = table.querySelector('tbody');
            teachers.forEach(teacher => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${teacher.username}</td>
                    <td><button class="delete-btn" onclick="deleteTeacher('${teacher.username}')"><i class="fas fa-trash-alt"></i></button></td>
                `;
                tbody.appendChild(row);
            });
            tableContainer.appendChild(table);
            teacherList.appendChild(tableContainer);
        }

        // --- Teacher, School Admin, & Dashboard Functions ---
        
        function updateClassesList(tab, showDeleteButton) {
            const classesList = document.getElementById(`${tab}-classes-list`);
            if (!classesList) return;

            classesList.innerHTML = '';
            const currentSchool = schools[currentSchoolKey];
            if (currentSchool && currentSchool.classes) {
                currentSchool.classes.forEach(className => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="class-name">${className}</span>`;
                    
                    if (showDeleteButton) {
                         li.innerHTML += `<button class="delete-btn" onclick="deleteClass('${className}')"><i class="fas fa-trash-alt"></i></button>`;
                    }
                    
                    li.onclick = () => {
                        document.querySelectorAll(`#${tab}-classes-list li`).forEach(item => item.classList.remove('active'));
                        li.classList.add('active');
                        if (tab === 'attendance') {
                            displayStudentsForAttendance(className);
                        } else if (tab === 'students') {
                            loadStudentList(className);
                        } else if (tab === 'reports') {
                            document.getElementById('detailed-report-class').value = className;
                        } else if (tab === 'dashboard') {
                            updateStats(className);
                            loadAlerts(className);
                        }
                    };
                    classesList.appendChild(li);
                });
            }
        }

        function displayAttendanceTab() {
            const today = new Date();
            const dateString = today.toLocaleDateString('so-SO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('current-date').textContent = dateString;
            document.getElementById('session-select').addEventListener('change', () => displayStudentsForAttendance(document.querySelector('#attendance-classes-list li.active')?.textContent));
        }

        function displayStudentsForAttendance(className) {
            const studentListContainer = document.getElementById('student-list-container');
            studentListContainer.innerHTML = '';
            
            if (!className) {
                studentListContainer.innerHTML = '<p>Fadlan dooro fasal si aad u diiwaangeliso attendance-ka.</p>';
                return;
            }

            const currentSchool = schools[currentSchoolKey];
            const students = currentSchool.students[className] || [];
            const today = new Date().toISOString().slice(0, 10);
            const session = document.getElementById('session-select').value;
            const attendanceKey = `${currentSchoolKey}-${today}-${className}-${session}`;
            const currentAttendance = attendanceData[attendanceKey] || {};

            if (students.length === 0) {
                studentListContainer.innerHTML = `<p>Fasalka <strong>${className}</strong> ma laha arday.</p>`;
                return;
            }

            students.forEach(student => {
                const status = currentAttendance[student.id] || 'unknown';
                const card = document.createElement('div');
                card.className = 'student-card';
                card.innerHTML = `
                    <div class="student-info">
                        <img src="${student.image}" alt="${student.name}">
                        <div class="student-details">
                            <h3>${student.name}</h3>
                            <p>Talafoon: ${student.id}</p>
                        </div>
                    </div>
                    <div class="attendance-actions" data-student-id="${student.id}">
                        <button class="attendance-btn btn-present ${status === 'present' ? 'active' : ''}" onclick="markAttendance('${student.id}', 'present', this)">Hadsan</button>
                        <button class="attendance-btn btn-absent ${status === 'absent' ? 'active' : ''}" onclick="markAttendance('${student.id}', 'absent', this)">Maqan</button>
                        <button class="attendance-btn btn-late ${status === 'late' ? 'active' : ''}" onclick="markAttendance('${student.id}', 'late', this)">Daahaday</button>
                    </div>
                `;
                studentListContainer.appendChild(card);
            });
        }

        function markAttendance(studentId, status, button) {
            const card = button.closest('.student-card');
            const attendanceActions = card.querySelector('.attendance-actions');
            attendanceActions.querySelectorAll('.attendance-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        }

        function saveAttendance() {
            const activeClassElement = document.querySelector('#attendance-classes-list li.active');
            if (!activeClassElement) {
                alert('Fadlan dooro fasal si aad u kaydiso attendance-ka.');
                return;
            }

            const className = activeClassElement.textContent.trim();
            const today = new Date().toISOString().slice(0, 10);
            const session = document.getElementById('session-select').value;
            const attendanceKey = `${currentSchoolKey}-${today}-${className}-${session}`;
            attendanceData[attendanceKey] = attendanceData[attendanceKey] || {};

            document.querySelectorAll('#student-list-container .student-card').forEach(card => {
                const studentId = card.querySelector('.attendance-actions').dataset.studentId;
                const activeBtn = card.querySelector('.attendance-btn.active');
                if (activeBtn) {
                    const status = activeBtn.textContent.toLowerCase().includes('hadsan') ? 'present' : (activeBtn.textContent.toLowerCase().includes('maqan') ? 'absent' : 'late');
                    attendanceData[attendanceKey][studentId] = status;
                }
            });

            saveData();
            alert('Attendance-ka si guul leh ayaa loo kaydiyey!');
            updateStats(className);
        }

        function exportAttendance() {
            const activeClassElement = document.querySelector('#attendance-classes-list li.active');
            if (!activeClassElement) {
                alert('Fadlan dooro fasal si aad u soo saarto warbixin PDF ah.');
                return;
            }

            const className = activeClassElement.textContent.trim();
            const today = new Date();
            const dateString = today.toLocaleDateString('so-SO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const session = document.getElementById('session-select').value;
            const attendanceKey = `${currentSchoolKey}-${today.toISOString().slice(0, 10)}-${className}-${session}`;
            const currentAttendance = attendanceData[attendanceKey] || {};
            const students = schools[currentSchoolKey].students[className] || [];

            if (students.length === 0) {
                alert('Fasalkan ma laha arday. Ma soo saari kartid warbixin.');
                return;
            }

            const doc = new jsPDF();
            doc.setFont('Helvetica', 'bold');
            doc.text(`Warbixinta Attendance-ka`, 14, 20);
            doc.setFont('Helvetica', 'normal');
            doc.text(`Dugsi: ${schools[currentSchoolKey].name}`, 14, 27);
            doc.text(`Fasal: ${className}`, 14, 34);
            doc.text(`Taariikhda: ${dateString}`, 14, 41);
            doc.text(`Fasax: ${session === 'morning' ? 'Subax' : 'Galab'}`, 14, 48);

            const tableColumn = ["Magaca Ardayga", "Lambarka Waalidka", "Xaaladda"];
            const tableRows = students.map(student => {
                const status = currentAttendance[student.id] || 'Ma Diiwaangashna';
                const statusText = status === 'present' ? 'Hadsan' : (status === 'absent' ? 'Maqan' : (status === 'late' ? 'Daahaday' : status));
                return [student.name, student.id, statusText];
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 55,
                theme: 'striped',
                headStyles: { fillColor: [52, 152, 219] }
            });

            doc.save(`Attendance_${className}_${today.toISOString().slice(0, 10)}.pdf`);
        }

        // Student Management Functions
        function addStudent() {
            const studentName = document.getElementById('student-name').value.trim();
            const studentId = document.getElementById('student-id').value.trim();
            const studentClass = document.getElementById('student-class').value;

            if (!studentName || !studentId || !studentClass) {
                alert('Fadlan buuxi dhammaan macluumaadka ardayga.');
                return;
            }

            const currentSchool = schools[currentSchoolKey];
            if (!currentSchool.students[studentClass]) {
                currentSchool.students[studentClass] = [];
            }
            const studentsInClass = currentSchool.students[studentClass];
            if (studentsInClass.find(s => s.id === studentId)) {
                alert('Ardaygan horey ayuu u jiraa fasalkan.');
                return;
            }

            const newStudent = {
                id: studentId,
                name: studentName,
                image: `https://ui-avatars.com/api/?name=${studentName.replace(' ', '+')}&background=3498db&color=fff`
            };
            studentsInClass.push(newStudent);
            saveData();
            alert('Ardayga si guul leh ayaa loo daray!');
            document.getElementById('student-name').value = '';
            document.getElementById('student-id').value = '';
            loadStudentList(studentClass);
        }

        function deleteStudent(studentId, className) {
            if (confirm(`Ma hubtaa inaad tirtirto ardayga?`)) {
                const currentSchool = schools[currentSchoolKey];
                currentSchool.students[className] = currentSchool.students[className].filter(s => s.id !== studentId);

                // Also delete attendance data for this student
                for (const key in attendanceData) {
                    if (key.startsWith(`${currentSchoolKey}-`) && key.includes(`-${className}-`)) {
                        delete attendanceData[key][studentId];
                    }
                }

                saveData();
                loadStudentList(className);
                alert('Ardayga si guul leh ayaa loo tirtiray!');
            }
        }

        function loadStudentList(className = null) {
            const studentListReport = document.getElementById('student-list-report');
            studentListReport.innerHTML = '';
            
            const currentSchool = schools[currentSchoolKey];
            let studentsToDisplay = [];
            
            if (className) {
                studentsToDisplay = currentSchool.students[className] || [];
            } else {
                studentsToDisplay = Object.values(currentSchool.students).flat();
            }

            if (studentsToDisplay.length === 0) {
                studentListReport.innerHTML = `<p>Ma jiraan arday la diiwaangeliyey fasalkan.</p>`;
                return;
            }
            
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';
            const table = document.createElement('table');
            table.className = 'report-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Magaca Ardayga</th>
                        <th>Lambarka Waalidka</th>
                        <th>Fasalka</th>
                        <th>Tirtir</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            `;
            const tbody = table.querySelector('tbody');
            studentsToDisplay.forEach(student => {
                const studentClass = Object.keys(currentSchool.students).find(key => currentSchool.students[key].some(s => s.id === student.id)) || 'N/A';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.id}</td>
                    <td>${studentClass}</td>
                    <td><button class="delete-btn" onclick="deleteStudent('${student.id}', '${studentClass}')"><i class="fas fa-trash-alt"></i></button></td>
                `;
                tbody.appendChild(row);
            });
            tableContainer.appendChild(table);
            studentListReport.appendChild(tableContainer);
        }

        function updateStudentClassSelect() {
            const select = document.getElementById('student-class');
            select.innerHTML = '<option value="">Dooro Fasalka</option>';
            const currentSchool = schools[currentSchoolKey];
            currentSchool.classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                select.appendChild(option);
            });
        }

        // Reports Tab Functions
        function updateReportFilters() {
            const classSelect = document.getElementById('detailed-report-class');
            classSelect.innerHTML = '<option value="">Dooro Fasalka</option>';
            const currentSchool = schools[currentSchoolKey];
            currentSchool.classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classSelect.appendChild(option);
            });
        }

        function generateDetailedReport() {
            const className = document.getElementById('detailed-report-class').value;
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            const reportResult = document.getElementById('detailed-report-result');
            reportResult.innerHTML = '';

            if (!className || !startDate || !endDate) {
                alert('Fadlan dooro fasal iyo laba taariikhood.');
                return;
            }

            const currentSchool = schools[currentSchoolKey];
            const allStudents = currentSchool.students[className] || [];
            if (allStudents.length === 0) {
                reportResult.innerHTML = `<p>Fasalka <strong>${className}</strong> ma laha arday. Ma soo saari kartid warbixin.</p>`;
                return;
            }

            const attendanceCounts = {};
            const datesInRange = getDatesInRange(startDate, endDate);
            
            allStudents.forEach(student => {
                attendanceCounts[student.id] = { present: 0, absent: 0, late: 0, total: datesInRange.length };
            });

            datesInRange.forEach(date => {
                const morningKey = `${currentSchoolKey}-${date}-${className}-morning`;
                const afternoonKey = `${currentSchoolKey}-${date}-${className}-afternoon`;
                const morningData = attendanceData[morningKey] || {};
                const afternoonData = attendanceData[afternoonKey] || {};

                allStudents.forEach(student => {
                    const morningStatus = morningData[student.id];
                    const afternoonStatus = afternoonData[student.id];

                    if (morningStatus === 'present' || afternoonStatus === 'present') {
                        attendanceCounts[student.id].present++;
                    } else if (morningStatus === 'absent' || afternoonStatus === 'absent') {
                        attendanceCounts[student.id].absent++;
                    } else if (morningStatus === 'late' || afternoonStatus === 'late') {
                        attendanceCounts[student.id].late++;
                    }
                });
            });

            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';
            const table = document.createElement('table');
            table.className = 'report-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Magaca Ardayga</th>
                        <th>Hadsan</th>
                        <th>Maqan</th>
                        <th>Daahaday</th>
                        <th>Tirada Guud</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            `;
            const tbody = table.querySelector('tbody');
            allStudents.forEach(student => {
                const counts = attendanceCounts[student.id];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${counts.present}</td>
                    <td>${counts.absent}</td>
                    <td>${counts.late}</td>
                    <td>${counts.present + counts.absent + counts.late}</td>
                `;
                tbody.appendChild(row);
            });
            tableContainer.appendChild(table);
            reportResult.appendChild(tableContainer);
        }

        function getDatesInRange(startDate, endDate) {
            const dates = [];
            let currentDate = new Date(startDate);
            const stopDate = new Date(endDate);
            while (currentDate <= stopDate) {
                dates.push(currentDate.toISOString().slice(0, 10));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        // Dashboard Functions
        function updateStats(className = null) {
            const today = new Date().toISOString().slice(0, 10);
            let presentCount = 0;
            let absentCount = 0;
            let lateCount = 0;
            let totalStudents = 0;
            const currentSchool = schools[currentSchoolKey];

            const classesToCount = className ? [className] : currentSchool.classes;

            classesToCount.forEach(cls => {
                const students = currentSchool.students[cls] || [];
                const morningAttendance = attendanceData[`${currentSchoolKey}-${today}-${cls}-morning`] || {};
                const afternoonAttendance = attendanceData[`${currentSchoolKey}-${today}-${cls}-afternoon`] || {};
                
                totalStudents += students.length;

                students.forEach(student => {
                    const status = morningAttendance[student.id] || afternoonAttendance[student.id];
                    if (status === 'present') {
                        presentCount++;
                    } else if (status === 'absent') {
                        absentCount++;
                    } else if (status === 'late') {
                        lateCount++;
                    }
                });
            });

            document.getElementById('present-count').textContent = presentCount;
            document.getElementById('absent-count').textContent = absentCount;
            document.getElementById('late-count').textContent = lateCount;
            document.getElementById('total-count').textContent = totalStudents;
        }

        function loadAlerts(className = null) {
            const alertList = document.getElementById('alert-list');
            alertList.innerHTML = '';
            const today = new Date();
            const currentSchool = schools[currentSchoolKey];
            const classesToAlert = className ? [className] : currentSchool.classes;

            classesToAlert.forEach(cls => {
                const students = currentSchool.students[cls] || [];
                students.forEach(student => {
                    let absentStreak = 0;
                    for (let i = 0; i < 5; i++) { // Check last 5 days
                        const date = new Date(today);
                        date.setDate(date.getDate() - i);
                        const dateString = date.toISOString().slice(0, 10);
                        const morningKey = `${currentSchoolKey}-${dateString}-${cls}-morning`;
                        const afternoonKey = `${currentSchoolKey}-${dateString}-${cls}-afternoon`;
                        const morningStatus = attendanceData[morningKey]?.[student.id];
                        const afternoonStatus = attendanceData[afternoonKey]?.[student.id];

                        if (morningStatus === 'absent' || afternoonStatus === 'absent') {
                            absentStreak++;
                        } else {
                            break;
                        }
                    }

                    if (absentStreak >= 3) {
                        const li = document.createElement('li');
                        li.textContent = `${student.name} oo fasalka ${cls} ah ayaa maqnaa ${absentStreak} maalmood oo isku xigta.`;
                        alertList.appendChild(li);
                    }
                });
            });

            if (alertList.innerHTML === '') {
                alertList.innerHTML = '<p>Ma jiraan wax ogeysiisyada cusub ah.</p>';
            }
        }
    </script>
</body>
</html>